"use strict";void 0===OSCOM.a.Account&&(OSCOM.a.Account={}),void 0===OSCOM.a.Account.Partner&&(OSCOM.a.Account.Partner={}),OSCOM.a.Account.Partner.Extend={execute:function(){let btDropinInstance,total_raw,taxDescriptions={DE19MWST:OSCOM.lang.partner_extend_purchase_tax_DE19MWST_title},pPackages,pPlanKeys,pPlanKeySelected;function showMessage(message){$("#pPayAlert").append("<p>"+message+"</p>").removeClass("d-none")}function updateOrderTable(){let selected=pPackages.plans[pPackages.selected].levels[pPlanKeySelected];$("#pPlanSelectedText").html(selected.title),$("#pPlanSelectedPrice").html(selected.price),total_raw=selected.total_raw,void 0!==selected.tax?($("#orderTableTaxTitle").html(taxDescriptions[Object.keys(selected.tax)[0]]+":"),$("#orderTableTax").html(selected.tax[Object.keys(selected.tax)[0]]),$("#orderTableTaxRow").removeClass("d-none")):$("#orderTableTaxRow").addClass("d-none"),$("#orderTableTotal").html(selected.total),$("#pPayButton").html(OSCOM.lang.partner_extend_pay_button.replace("#amount#",selected.total)),void 0!==btDropinInstance&&(btDropinInstance.updateConfiguration("threeDSecure","amount",selected.total_raw),btDropinInstance.updateConfiguration("paypal","amount",selected.total_raw),btDropinInstance._merchantConfiguration.paymentOptionPriority.includes("googlePay")&&btDropinInstance.updateConfiguration("googlePay","transactionInfo",{totalPriceStatus:"FINAL",totalPrice:selected.total_raw,currencyCode:OSCOM.currency}))}function initializeBt(){$("#pPayButton").siblings().addClass("d-none"),$("#pPayButton").addClass("d-none").prop("disabled",!0),$("#pPayButton").data("original-text")&&$("#pPayButton").html($("#pPayButton").data("original-text")).removeData("original-text"),$.getJSON(OSCOM.a.vars.rpc_braintree_client_token_url.replace("CURRENCY_CODE",OSCOM.currency),function(result){if(void 0!==result.rpcStatus&&1===result.rpcStatus&&void 0!==result.token)try{$("#currencySelector").val(result.currency),OSCOM.currency=result.currency,Cookies.set("oscom_currency",result.currency,{expires:365}),pPackages={selected:result.plan,plans:result.packages},pPlanKeys=Object.keys(pPackages.plans[pPackages.selected].levels),void 0===pPlanKeySelected&&(pPlanKeySelected=pPackages.plans[pPackages.selected].selected),pPlanKeys.length<13?($("#pPlanDurationSelection").parent().addClass("d-none"),$("#pPlanSelection").empty(),$.each(pPackages.plans[pPackages.selected].levels,function(lid,lvalue){$("#pPlanSelection").append($("<option/>",{value:lid,text:lvalue.title+" "+lvalue.price}))}),$("#pPlanSelection").val(pPlanKeySelected),$("#pPlanSelection").parent().removeClass("d-none")):($("#pPlanSelection").parent().addClass("d-none"),$("#pPlanDurationSelection").attr("max",pPlanKeys.length-1),$("#pPlanDurationSelection").val(pPlanKeys.indexOf(pPlanKeySelected.toString())),$("#pPlanDurationSelection").parent().removeClass("d-none")),updateOrderTable(),createDropinInstance(result)}catch(err){return $("#pBtFormIndicator").addClass("d-none"),showMessage(OSCOM.lang.partner_extend_error_payment_general),!1}else $("#pBtFormIndicator").addClass("d-none"),showMessage(OSCOM.lang.partner_extend_error_payment_general)}).fail(function(){$("#pBtFormIndicator").addClass("d-none"),showMessage(OSCOM.lang.partner_extend_error_payment_general)})}function createDropinInstance(result){if("undefined"==typeof braintree){let script=document.createElement("script");return script.src=result.braintree_web_dropin_url,document.body.append(script),script.onload=function(){createDropinInstance(result)},script.onerror=function(){$("#pBtFormIndicator").addClass("d-none"),showMessage(OSCOM.lang.partner_extend_error_payment_general)},!1}let btDropinParams={authorization:result.token,container:"#pBtForm",paymentOptionPriority:["paypal","card"],threeDSecure:{amount:total_raw},paypal:{flow:"checkout",amount:total_raw,currency:OSCOM.currency,displayName:"osCommerce",enableShippingAddress:!1,buttonStyle:{size:"small",color:"blue",shape:"rect"}}};void 0!==result.googleMerchantId&&(btDropinParams.paymentOptionPriority.push("googlePay"),btDropinParams.googlePay={googlePayVersion:2,merchantInfo:{merchantId:result.googleMerchantId,merchantName:"osCommerce"},transactionInfo:{totalPriceStatus:"FINAL",totalPrice:total_raw,currencyCode:OSCOM.currency},allowedPaymentMethods:[{type:"CARD",parameters:{billingAddressRequired:!0,billingAddressParameters:{format:"FULL"}}}]}),braintree.dropin.create(btDropinParams,function(createErr,instance){if($("#pBtFormIndicator").addClass("d-none"),createErr)return showMessage(OSCOM.lang.partner_extend_error_payment_general),!1;btDropinInstance=instance,$("#pCurrencyContent, #pBillingContent, #pBtForm, #pPayButton").removeClass("d-none"),!0===$("#currencySelector").prop("disabled")&&$("#currencySelector").prop("disabled",!1),btDropinInstance.isPaymentMethodRequestable()&&($("#pPayButton").siblings().removeClass("d-none"),$("#pPayButton").removeClass("btn-secondary").addClass("btn-success").prop("disabled",!1)),btDropinInstance.on("paymentMethodRequestable",function(){$("#pPayButton").html()!=$("#pPayButton").data("processing-text")&&($("#pPayButton").siblings().removeClass("d-none"),$("#pPayButton").removeClass("btn-secondary").addClass("btn-success").prop("disabled",!1))}),btDropinInstance.on("noPaymentMethodRequestable",function(){$("#pPayButton").siblings().addClass("d-none"),$("#pPayButton").removeClass("btn-success").addClass("btn-secondary").prop("disabled",!0)})})}function processTransaction(nonce){let params={nonce:nonce,plan:pPackages.selected,duration:pPlanKeySelected};$.post(OSCOM.a.vars.rpc_braintree_process_url.replace("CURRENCY_CODE",OSCOM.currency),params,function(result){void 0!==result.rpcStatus?1===result.rpcStatus?window.location=OSCOM.a.vars.rpc_braintree_success_url:(reinitializeBt(),showMessage(OSCOM.lang.partner_extend_error_payment_transaction+" "+result.errorMessage)):(reinitializeBt(),showMessage(OSCOM.lang.partner_extend_error_payment_general))},"json").fail(function(){reinitializeBt(),showMessage(OSCOM.lang.partner_extend_error_payment_general)})}function reinitializeBt(){btDropinInstance.clearSelectedPaymentMethod(),$("#pPayButton").data("original-text")&&$("#pPayButton").html($("#pPayButton").data("original-text")).removeData("original-text"),$("#pPayButton").siblings().addClass("d-none"),$("#pPayButton").removeClass("btn-success").addClass("btn-secondary").prop("disabled",!0)}$("#currencySelector").on("change",function(e){$("#currencySelector").prop("disabled",!0),$("#pBtFormIndicator").removeClass("d-none"),$("#pBillingContent, #pBtForm, #pPayButton").addClass("d-none"),OSCOM.currency=this.value,void 0!==btDropinInstance&&btDropinInstance.teardown(function(){initializeBt()})}),$("#pPlanSelection").on("change",function(){pPlanKeySelected=this.value,updateOrderTable()}),$("#pPlanDurationSelection").on("input",function(){pPlanKeySelected=pPlanKeys[this.value],updateOrderTable()}),$("#pPayButton").on("click",function(e){e.preventDefault(),$("#pPayAlert").empty().addClass("d-none"),$("#pPayButton").siblings().addClass("d-none"),$("#pPayButton").data("original-text",$("#pPayButton").html()).html($("#pPayButton").data("processing-text")).prop("disabled",!0),btDropinInstance.requestPaymentMethod(function(requestPaymentMethodErr,payload){return requestPaymentMethodErr?(showMessage(OSCOM.lang.partner_extend_error_payment_general),$("#pPayButton").data("original-text")&&$("#pPayButton").html($("#pPayButton").data("original-text")).removeData("original-text"),$("#pPayButton").siblings().removeClass("d-none"),$("#pPayButton").prop("disabled",!1),!1):"CreditCard"===payload.type&&!0!==payload.liabilityShifted&&!1!==payload.liabilityShiftPossible?(reinitializeBt(),showMessage(OSCOM.lang.partner_extend_error_payment_general),!1):void processTransaction(payload.nonce)})}),initializeBt();let dateNow=new Date,dateEnd=new Date(OSCOM.a.vars.partnerCampaign.dateEnd);if(dateEnd instanceof Date&&!isNaN(dateEnd)&&$(".pcdate").html(dateEnd.toLocaleDateString(void 0,{year:"numeric",month:"long",day:"numeric"})),1!==OSCOM.a.vars.partnerCampaign.status)$(".pcdate").addClass("badge-danger");else{let diffDays;Math.round(Math.abs((dateEnd.getTime()-dateNow.getTime())/864e5))>14?$(".pcdate").addClass("badge-success"):$(".pcdate").addClass("badge-warning")}}},"Account"===OSCOM.siteReq.app&&"Partner.Extend"===OSCOM.siteReq.actions.join(".")&&OSCOM.a.Account.Partner.Extend.execute();
//# sourceMappingURL=Extend.min.js.map