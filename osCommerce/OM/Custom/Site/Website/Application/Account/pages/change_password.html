<div class="row">
  {widget}account_sidebar_nav{widget}

  <div id="maincontainer" class="col-sm-9 col-sm-pull-3">
    <div id="maincontent">
      <h1>{lang}change_password_title{lang}</h1>

      {lang}change_password_introduction{lang}

      <form id="formChangePassword">{formprotect}public_token{formprotect}
        {widget}message_stack|account{widget}

        <div class="alert alert-danger hidden" role="alert"></div>

        <div class="form-group">
          <label class="control-label" for="inputCurrentPassword">{lang}change_password_current_password_title{lang}</label>

          <input type="password" id="inputCurrentPassword" name="current_password" class="form-control" autocomplete="current-password" />
          <span class="help-block small"><span id="inputCurrentPasswordAlert" class="hidden" style="padding-right: 10px;"></span></span>
        </div>

        <div class="form-group">
          <label class="control-label" for="inputNewPassword">{lang}change_password_new_password_title{lang}</label>

          <input type="password" id="inputNewPassword" name="new_password" class="form-control" autocomplete="new-password" />
          <span class="help-block small"><span id="inputNewPasswordAlert" class="hidden" style="padding-right: 10px;"></span><span class="text-muted">{lang}change_password_new_note{lang}</span></span>
        </div>

        <p>
          <button type="submit" id="changePasswordButton" class="btn btn-info" data-processing-text="{lang addslashes}change_password_processing_button_title{lang}">{lang}change_password_button_title{lang}</button>
          <a href="{link}Account{link}" class="btn btn-link">{lang}change_password_cancel_button_title{lang}</a>
        </p>
      </form>
    </div>
  </div>
</div>

<script>
function checkCurrentPassword() {
  if (!$('#inputCurrentPasswordAlert').hasClass('hidden')) {
    $('#inputCurrentPasswordAlert').addClass('hidden');
    $('#inputCurrentPassword').closest('.form-group').removeClass('has-error');
  }

  if ($('#inputCurrentPassword').val() == '') {
    $('#inputCurrentPasswordAlert').html({lang json_encode}change_password_js_error_required{lang}).removeClass('hidden');
  } else if ($('#inputCurrentPassword').val().length < 3) {
    $('#inputCurrentPasswordAlert').html({lang json_encode}change_password_js_error_short{lang}).removeClass('hidden');
  } else if ($('#inputCurrentPassword').val().length > 32) {
    $('#inputCurrentPasswordAlert').html({lang json_encode}change_password_js_error_long{lang}).removeClass('hidden');
  }

  if (!$('#inputCurrentPasswordAlert').hasClass('hidden')) {
    $('#inputCurrentPassword').closest('.form-group').addClass('has-error');
  }

  return $('#inputCurrentPasswordAlert').hasClass('hidden');
}

function checkNewPassword() {
  if (!$('#inputNewPasswordAlert').hasClass('hidden')) {
    $('#inputNewPasswordAlert').addClass('hidden');
    $('#inputNewPassword').closest('.form-group').removeClass('has-error');
  }

  if ($('#inputNewPassword').val() == '') {
    $('#inputNewPasswordAlert').html({lang json_encode}change_password_js_error_required{lang}).removeClass('hidden');
  } else if ($('#inputNewPassword').val().length < 3) {
    $('#inputNewPasswordAlert').html({lang json_encode}change_password_js_error_short{lang}).removeClass('hidden');
  } else if ($('#inputNewPassword').val().length > 32) {
    $('#inputNewPasswordAlert').html({lang json_encode}change_password_js_error_long{lang}).removeClass('hidden');
  }

  if (!$('#inputNewPasswordAlert').hasClass('hidden')) {
    $('#inputNewPassword').closest('.form-group').addClass('has-error');
  }

  return $('#inputNewPasswordAlert').hasClass('hidden');
}

function checkForm() {
  var has_error = false;

  if (!checkCurrentPassword()) {
    has_error = true;
  }

  if (!checkNewPassword()) {
    has_error = true;
  }

  return !has_error;
}

$(function() {
  var error_change_password_general = {lang json_encode}change_password_ms_error_general{lang};

  $('#formChangePassword').submit(function(e) {
    e.preventDefault();

    if ($('#changePasswordButton').prop('disabled') === true) {
      return false;
    }

    $('#formChangePassword div.alert').empty().addClass('hidden');

    $('#changePasswordButton').button('processing').prop('disabled', true);

    if (!checkForm()) {
      $('#changePasswordButton').button('reset').prop('disabled', false);
    } else {
      var params = {
        public_token: $('#formChangePassword input[name="public_token"]').val(),
        current_password: $('#inputCurrentPassword').val(),
        new_password: $('#inputNewPassword').val()
      };

      $.post('{rpclink}ChangePassword|Account|Website{rpclink}', params, function (result) {
        if (typeof result.rpcStatus !== 'undefined') {
          if (result.rpcStatus === 1) {
            window.location = {json}{link}Account|Website|ms=password_changed|SSL{link}{json};
          } else {
            if ((typeof result.errorCode !== 'undefined') && (result.errorCode === 'not_logged_in')) {
              window.location = {json}{link}Account|Website|Login&ms=change_password_not_logged_in|SSL{link}{json};
            } else {
              var e = (typeof result.errors !== 'undefined') ? result.errors : [];

              if (e.length < 1) {
                e.push(error_change_password_general);
              }

              e.forEach(function(v) {
                $('#formChangePassword div.alert-danger').append('<p>' + v + '</p>').removeClass('hidden');
              });
            }
          }
        } else {
          $('#formChangePassword div.alert-danger').append('<p>' + error_change_password_general + '</p>').removeClass('hidden');
        }
      }, 'json').fail(function() {
        $('#formChangePassword div.alert-danger').append('<p>' + error_change_password_general + '</p>').removeClass('hidden');
      }).always(function() {
        $('#changePasswordButton').button('reset').prop('disabled', false);
      });
    }
  });
});
</script>
