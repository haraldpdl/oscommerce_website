<div id="highlights">
  <img src="{ifvalue partner image_big_path}{publiclink}{value}partner image_big_path{value}{publiclink}{else}{publiclink}{value}highlights_image{value}{publiclink}{ifvalue}" alt="" title="{value}partner title{value}" />
</div>

<div class="row">
  {widget}account_sidebar_nav{widget}

  <div id="maincontainer" class="col-sm-9 col-sm-pull-3">
    <div id="maincontent">
      <div class="pull-right"><span class="pcdate label">{value}partner_campaign date_end{value}</span><br /><span class="pcdays text-muted small"></span></div>

      <h1>{value}partner title{value}</h1>

      {widget}message_stack|partner{widget}

      <h2>{lang}partner_extension_title{lang}</h2>

      <p>{lang}partner_extension_description{lang}</p>

      <div class="col-xs-6">
        <ul id="pPlanTabs" class="nav nav-tabs" role="tablist"></ul>

        <div id="pPlanTabsContent" class="tab-content"></div>
      </div>

      <div class="col-xs-6">
        <div class="panel panel-info">
          <div class="panel-heading text-center">
            <h3 id="pPlanTitle" class="panel-title"></h3>
          </div>

          <div class="panel-body">
            <form id="pForm" action="{link}Account|Website|Partner&Extend={raw}partner code{raw}&Payment&Process|SSL{link}" method="post" class="form">
              <input type="hidden" name="plan" value="">

              <div class="form-group">
                <label for="pPlanSelection">{lang}cs_plans_duration_title{lang}</label>

                <select id="pPlanSelection" name="duration" class="form-control"></select>
              </div>

              <ul id="pPaymentMethodTabs" class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active"><a href="#pPaymentPayPal" aria-controls="pPaymentPayPal" role="tab" data-toggle="tab">{lang}cs_payment_tab_paypal{lang}</a></li>
                <li role="presentation"><a href="#pPaymentCc" aria-controls="pPaymentCc" role="tab" data-toggle="tab">{lang}cs_payment_tab_credit_card{lang}</a></li>
              </ul>

              <div class="tab-content">
                <div role="tabpanel" class="tab-pane active" id="pPaymentPayPal">
                  <button type="button" id="pPayPalPayButton" class="btn btn-info paypal-button-hidden">{lang}cs_pay_paypal_button{lang}</button>
                </div>

                <div role="tabpanel" class="tab-pane" id="pPaymentCc">
                  <div id="cc-payment-form"></div>

                  <button type="submit" id="pCcPayButton" class="btn btn-info hidden"></button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="clearfix"></div>

      <p class="text-center"><small class="text-muted">{lang}cs_pricing_info{lang}</small></p>

      <h3>{lang}partner_extension_after_payment_title{lang}</h3>

      {lang}partner_extension_after_payment_description{lang}
    </div>
  </div>
</div>

<script>
var pPackages = {
  selected: {raw json_encode}partner_campaign pkg_code{raw},
  plans: {raw json_encode}partner_packages{raw}
};

pPackages.plans.silver.desc = [
  {
    title: '{lang addslashes}cs_plans_service_partner_listing{lang}',
    checked: true
  },
  {
    title: '{lang addslashes}cs_plans_service_commercial_inquiries{lang}',
    checked: true
  },
  {
    title: '{lang addslashes}cs_plans_service_commercial_feedback{lang}',
    checked: true
  },
  {
    title: '{lang addslashes}cs_plans_service_profile{lang}',
    checked: true
  }
];

pPackages.plans.gold.desc = [
  {
    title: '{lang addslashes}cs_plans_service_silver_level{lang}',
    checked: true
  },
  {
    title: '{lang addslashes}cs_plans_service_partner_page{lang}',
    checked: true
  },
  {
    title: '{lang addslashes}cs_plans_service_promotions{lang}',
    checked: true
  },
  {
    title: '{lang addslashes}cs_plans_service_banner{lang}',
    checked: true
  },
  {
    title: '{lang addslashes}cs_plans_service_forum_channel{lang}',
    checked: true
  },
  {
    title: '{lang addslashes}cs_plans_service_showcase_sites{lang}',
    checked: true
  },
  {
    title: '{lang addslashes}cs_plans_service_extra{lang}',
    checked: false
  }
];

$.each(pPackages.plans, function(index, value) {
  $('#pPlanTabs').append('<li role="presentation"><a data-target="#p' + index + 'Content" data-toggle="tab" data-code="' + index + '" aria-controls="p' + index + 'Content" role="tab">' + value.title_short + '</a></li>');

  $('#pPlanTabsContent').append('<div role="tabpanel" class="tab-pane" id="p' + index + 'Content"><table class="table table-hover table-borderless"><tbody></tbody></table></div>');

  $.each(value.desc, function(i, d) {
    var row = '<tr><td>' + d.title + '</td><td align="center">';

    if (d.checked === true) {
      row += '<i class="fa fa-check-square" style="color: #5cb85c; font-size: 1.6em;"></i>';
    }

    row += '</td></tr>';

    $('#p' + index + 'Content table tbody').append(row);
  });
});

$('#pPlanTabs li a[data-code="' + pPackages.selected + '"]').parent('li').addClass('active');
$('#p' + pPackages.selected + 'Content').addClass('active');

$('#pPlanTitle').html(pPackages.plans[pPackages.selected].title);

$('#pForm input[name="plan"]').val(pPackages.selected);

$.each(pPackages.plans[pPackages.selected].levels, function(lid, lvalue) {
  $('#pPlanSelection').append($('<option/>', {
    value: lid,
    text: lvalue.title + ' ' + lvalue.price + ' €'
  }));
});

$('#pPlanSelection').val(pPackages.plans[pPackages.selected].selected);

var pPayCcButtonText = '{lang addslashes}cs_pay_credit_card_button{lang}';

$('#pCcPayButton').html(pPayCcButtonText.replace('#amount#', pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].price) + ' €');

$('#pForm').on('submit', function() {
  $('#pCcPayButton').data('orig-button-text', $('#pCcPayButton').html());
  $('#pCcPayButton').html('{lang addslashes}cs_pay_processing_button{lang}').prop('disabled', true);
});

window.paypalCheckoutReady = function() {
  paypal.checkout.setup('{value}paypal_merchant_id{value}', {
    environment: '{value}paypal_server{value}' != 'live' ? 'sandbox' : 'production',
    button: 'pPayPalPayButton',
    click: function(e) {
      e.preventDefault();

      var p = {
        plan: pPackages.selected,
        duration: pPackages.plans[pPackages.selected].selected.toString()
      };

      var keys = [];
      for (var k in pPackages.plans[pPackages.selected].levels) {
        keys.push(k);
      }

      if ($.inArray(p.duration, keys) === -1) {
        $('#pPlanSelection').closest('.form-group').addClass('has-error');

        toastr.error('{lang addslashes}error_partner_unknown_plan{lang}');

        return false;
      }

      if ($('#pPlanSelection').closest('.form-group').hasClass('has-error')) {
        $('#pPlanSelection').closest('.form-group').removeClass('has-error');
      }

      toastr.remove();

      paypal.checkout.initXO();

      var ppCall = $.post('{raw addslashes}payment_init_url{raw}', p, null, 'json');

      ppCall.done(function (data) {
        if (typeof data.token !== 'undefined') {
          paypal.checkout.startFlow('https://www.' + ('{value}paypal_server{value}' != 'live' ? 'sandbox.' : '') + 'paypal.com/checkoutnow?useraction=commit&token=' + data.token);
        } else {
          toastr.error('{lang addslashes}error_partner_payment_initialization{lang}');

          paypal.checkout.closeFlow();
        }
      });

      ppCall.fail(function () {
        paypal.checkout.closeFlow();
      });
    }
  });
};

$.getJSON('{raw addslashes}braintree_get_client_token_url{raw}', function (result) {
  if ((typeof result.rpcStatus !== 'undefined') && (result.rpcStatus === 1) && (typeof result.token !== 'undefined')) {
    braintree.setup(result.token, 'dropin', {
      container: 'cc-payment-form',
      form: 'pForm',
      onReady: function (obj) {
        $('#pCcPayButton').removeClass('hidden');
      },
      onError: function (obj) {
        if (typeof $('#pCcPayButton').data('orig-button-text') !== 'undefined') {
          $('#pCcPayButton').html($('#pCcPayButton').data('orig-button-text')).prop('disabled', false);
          $('#pCcPayButton').removeData('orig-button-text');
        }
      }
    });
  }
});

$('#pPlanTabs a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
  var p = $(e.target).data('code');

  pPackages.selected = p;

  $('#pPlanTitle').html(pPackages.plans[pPackages.selected].title);

  $('#pForm input[name="plan"]').val(pPackages.selected);

  $('#pPlanSelection').find('option').remove();

  $.each(pPackages.plans[pPackages.selected].levels, function(lid, lvalue) {
    $('#pPlanSelection').append($('<option/>', {
      value: lid,
      text: lvalue.title + ' ' + lvalue.price + ' €'
    }));
  });

  $('#pPlanSelection').val(pPackages.plans[pPackages.selected].selected);

  $('#pCcPayButton').html(pPayCcButtonText.replace('#amount#', pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].price) + ' €');
});

$('#pPlanSelection').on('change', function() {
  pPackages.plans[pPackages.selected].selected = this.value;

  $('#pCcPayButton').html(pPayCcButtonText.replace('#amount#', pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].price) + ' €');
});

$(function() {
  var partner_date_now = moment('{value addslashes}partner_date_now{value}');
  var runsUntil = moment($('.pcdate').text());

  $('.pcdate').text(runsUntil.format('Do MMM, YYYY'));

  if (runsUntil.isBefore(partner_date_now)) {
    $('.pcdate').addClass('label-danger');

    $('.pcdays').html(runsUntil.from(partner_date_now));
  } else {
    var daysRemaining = runsUntil.diff(partner_date_now, 'days');

    $('.pcdays').html(partner_date_now.to(runsUntil));

    if ( daysRemaining > 14 ) {
      $('.pcdate').addClass('label-success');
    } else {
      $('.pcdate').addClass('label-warning');
    }
  }
});
</script>

<script src="https://js.braintreegateway.com/js/braintree-2.30.0.min.js"></script>
<script src="public/external/momentjs/moment.min.js"></script>
<script src="https://www.paypalobjects.com/api/checkout.js" async></script>
