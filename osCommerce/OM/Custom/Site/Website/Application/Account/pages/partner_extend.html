<div class="row">
  {widget}account_sidebar_nav{widget}

  <div id="maincontainer" class="col-lg-9">
    <div id="maincontent">
      <div class="float-right text-right"><span class="pcdate badge"></span><br><small class="text-muted">{value}partner_campaign relative_date{value}</small></div>

      <h1 class="display-4">{lang}partner_extension_title{lang}</h1>

      <h2>{value}partner title{value}</h2>

      <p class="lead">{lang}partner_extension_description{lang}</p>

      {widget}message_stack|partner{widget}

      <div class="row">
        <div class="col-6">
          <table class="table table-hover table-borderless">
            <tbody>
              <tr>
                <td style="vertical-align: middle;">{lang}cs_plans_service_partner_page{lang}</td>
                <td class="text-center text-success" style="font-size: 140%;">{fa}check-square{fa}</td>
              </tr>
              <tr>
                <td style="vertical-align: middle;">{lang}cs_plans_service_promotions{lang}</td>
                <td class="text-center text-success" style="font-size: 140%;">{fa}check-square{fa}</td>
              </tr>
              <tr>
                <td style="vertical-align: middle;">{lang}cs_plans_service_administration_dashboard{lang}</td>
                <td class="text-center text-success" style="font-size: 140%;">{fa}check-square{fa}</td>
              </tr>
              <tr>
                <td style="vertical-align: middle;">{lang}cs_plans_service_banner{lang}</td>
                <td class="text-center text-success" style="font-size: 140%;">{fa}check-square{fa}</td>
              </tr>
              <tr>
                <td style="vertical-align: middle;">{lang}cs_plans_service_forum_channel{lang}</td>
                <td class="text-center text-success" style="font-size: 140%;">{fa}check-square{fa}</td>
              </tr>
              <tr>
                <td style="vertical-align: middle;">{lang}cs_plans_service_showcase_sites{lang}</td>
                <td class="text-center text-success" style="font-size: 140%;">{fa}check-square{fa}</td>
              </tr>
              <tr>
                <td style="vertical-align: middle;">{lang}cs_plans_service_commercial_inquiries{lang}</td>
                <td class="text-center text-success" style="font-size: 140%;">{fa}check-square{fa}</td>
              </tr>
              <tr>
                <td style="vertical-align: middle;">{lang}cs_plans_service_extra{lang}</td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="col-6">
          <div class="card bg-light">
            <div class="card-body">
              <div class="text-right mb-2">
                <img src="{publiclink}images/braintree-badge-wide-light.png{publiclink}" width="202px" height="32px" border="0" alt="Payments by Braintree">
              </div>

              <form id="pForm" class="form">
                <address>{raw}partner_billing_address_formatted{raw}</address>

                <div id="pFormBillingContent" class="d-none">
                  <div class="form-group mb-0">
                    <label for="pPlanDurationSelection">{lang}cs_plans_duration_title{lang}</label>
                    <input type="range" id="pPlanDurationSelection" class="custom-range" min="0">
                  </div>

                  <div class="form-group d-none">
                    <label for="pPlanSelection">{lang}cs_plans_duration_title{lang}</label>

                    <select id="pPlanSelection" name="duration" class="form-control"></select>
                  </div>

                  <table id="orderTable" class="table table-condensed">
                    <thead>
                      <tr>
                        <th colspan="2" class="border-top-0">{lang}partner_extension_partnership_title{lang}</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td id="pPlanSelectedText" style="width: 70%;"></td>
                        <td id="pPlanSelectedPrice" class="pr-0 text-right" style="width: 30%;"></td>
                      </tr>
                      <tr id="orderTableTaxRow" class="d-none">
                        <td id="orderTableTaxTitle" class="text-right" style="width: 70%;"></td>
                        <td id="orderTableTax" class="pr-0 text-right" style="width: 30%;"></td>
                      </tr>
                      <tr>
                        <td class="text-right" style="width: 70%;">{lang}purchase_item_total{lang}:</td>
                        <td id="orderTableTotal" class="pr-0 text-right" style="width: 30%;"></td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div id="pPayAlert" class="alert alert-danger d-none" role="alert"></div>

                <div id="pBtFormIndicator" class="text-center"><span class="spinner-border" role="status"></span></div>
                <div id="pBtForm"></div>

                <p class="text-right">
                  {fa}arrow-right|d-none text-success{fa}
                  <button type="button" id="pPayButton" class="btn btn-secondary d-none" data-processing-text="{escape}{lang}cs_pay_processing_button{lang}{escape}" disabled></button>
                </p>
              </form>
            </div>
          </div>

          <p class="small text-muted text-center mt-2">{lang}cs_pricing_info{lang}</p>
        </div>
      </div>

      <div class="jumbotron p-4 border" style="font-size: 0.9em;">
        <h5>{lang}partner_extension_after_payment_title{lang}</h5>

        {lang}partner_extension_after_payment_description{lang}
      </div>
    </div>
  </div>
</div>

<script>
var btDropinInstance;

var total_raw;

var pPayButtonText = {lang json_encode}cs_pay_credit_card_button{lang};

var error_payment_general = {lang json_encode}error_partner_payment_general{lang};

var taxDescriptions = {
  'DE19MWST': {lang json_encode}purchase_tax_DE19MWST_title{lang}
};

var pPackages = {
  selected: 'gold',//{raw json_encode}partner_campaign pkg_code{raw},
  plans: {raw json_encode}partner_packages{raw}
};

var pPlanKeys = Object.keys(pPackages.plans[pPackages.selected].levels);

function showMessage(message) {
  $('#pPayAlert').append('<p>' + message + '</p>').removeClass('d-none');
}

function updateOrderTable() {
  $('#pPlanSelectedText').html(pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].title);
  $('#pPlanSelectedPrice').html(pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].price);

  total_raw = pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].total_raw;

  if (typeof pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].tax !== 'undefined') {
    var t = pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].tax;

    $('#orderTableTaxTitle').html(taxDescriptions[Object.keys(t)[0]] + ':');
    $('#orderTableTax').html(t[Object.keys(t)[0]]);
    $('#orderTableTaxRow').removeClass('d-none');
  } else {
    $('#orderTableTaxRow').addClass('d-none');
  }

  $('#orderTableTotal').html(pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].total);

  $('#pPayButton').html(pPayButtonText.replace('#amount#', pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].total));

  if (typeof btDropinInstance !== 'undefined') {
    btDropinInstance.updateConfiguration('threeDSecure', 'amount', pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].total_raw);
    btDropinInstance.updateConfiguration('paypal', 'amount', pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].total_raw);
  }
}

if (pPlanKeys.length < 13) {
  $('#pPlanDurationSelection').parent().addClass('d-none');

  $.each(pPackages.plans[pPackages.selected].levels, function(lid, lvalue) {
    $('#pPlanSelection').append($('<option/>', {
      value: lid,
      text: lvalue.title + ' ' + lvalue.price
    }));
  });

  $('#pPlanSelection').val(pPackages.plans[pPackages.selected].selected);
  $('#pPlanSelection').parent().removeClass('d-none');

  $('#pPlanSelection').on('change', function() {
    pPackages.plans[pPackages.selected].selected = this.value;

    updateOrderTable();
  });
} else {
  $('#pPlanDurationSelection').attr('max', pPlanKeys.length - 1);
  $('#pPlanDurationSelection').val(pPlanKeys.indexOf(pPackages.plans[pPackages.selected].selected.toString()));

  $('#pPlanDurationSelection').on('input', function() {
    pPackages.plans[pPackages.selected].selected = pPlanKeys[this.value];

    updateOrderTable();
  });
}

updateOrderTable();

function initializeBt() {
  $('#pBtFormIndicator').removeClass('d-none')

  $('#pPayButton').siblings().addClass('d-none');
  $('#pPayButton').addClass('d-none').prop('disabled', true);

  if ($('#pPayButton').data('original-text')) {
    $('#pPayButton').html($('#pPayButton').data('original-text')).removeData('original-text');
  }

  $.getJSON({raw json_encode}braintree_get_client_token_url{raw}, function (result) {
    if ((typeof result.rpcStatus !== 'undefined') && (result.rpcStatus === 1) && (typeof result.token !== 'undefined')) {
      braintree.client.create({
        authorization: result.token
      }, function (clientErr, clientInstance) {
        $('#pBtFormIndicator').addClass('d-none');

        if (clientErr) {
          showMessage(error_payment_general);

          return false;
        }

        try {
          createDropinInstance(result);
        } catch (err) {
          showMessage(error_payment_general);

          return false;
        }
      });
    } else {
      $('#pBtFormIndicator').addClass('d-none');

      showMessage(error_payment_general);
    }
  }).fail(function() {
    $('#pBtFormIndicator').addClass('d-none');

    showMessage(error_payment_general);
  });
}

function createDropinInstance(result) {
  braintree.dropin.create({
    authorization: result.token,
    container: '#pBtForm',
    paymentOptionPriority: ['paypal', 'card'],
    threeDSecure: {
      amount: total_raw
    },
    paypal: {
      flow: 'checkout',
      amount: total_raw,
      currency: 'EUR',
      displayName: 'osCommerce',
      enableShippingAddress: false,
      buttonStyle: {
        size: 'small',
        color: 'blue',
        shape: 'rect'
      }
    }
  }, function (createErr, instance) {
    if (createErr) {
      showMessage(error_payment_general);

      return false;
    }

    btDropinInstance = instance;

    $('#pFormBillingContent').removeClass('d-none');
    $('#pPayButton').removeClass('d-none');

    if (btDropinInstance.isPaymentMethodRequestable()) {
      $('#pPayButton').siblings().removeClass('d-none');
      $('#pPayButton').removeClass('btn-secondary').addClass('btn-success').prop('disabled', false);
    }

    btDropinInstance.on('paymentMethodRequestable', function (event) {
      if ($('#pPayButton').html() != $('#pPayButton').data('processing-text')) {
        $('#pPayButton').siblings().removeClass('d-none');
        $('#pPayButton').removeClass('btn-secondary').addClass('btn-success').prop('disabled', false);
      }
    });

    btDropinInstance.on('noPaymentMethodRequestable', function () {
      $('#pPayButton').siblings().addClass('d-none');
      $('#pPayButton').removeClass('btn-success').addClass('btn-secondary').prop('disabled', true);
    });
  });
}

$('#pPayButton').on('click', function(e) {
  e.preventDefault();

  $('#pPayAlert').empty().addClass('d-none');

  $('#pPayButton').siblings().addClass('d-none');
  $('#pPayButton').data('original-text', $('#pPayButton').html()).html($('#pPayButton').data('processing-text')).prop('disabled', true);

  btDropinInstance.requestPaymentMethod(function (requestPaymentMethodErr, payload) {
    if (requestPaymentMethodErr) {
      showMessage(error_payment_general);

      if ($('#pPayButton').data('original-text')) {
        $('#pPayButton').html($('#pPayButton').data('original-text')).removeData('original-text');
      }

      $('#pPayButton').siblings().removeClass('d-none');
      $('#pPayButton').prop('disabled', false);

      return false;
    }

    if ((payload.type !== 'CreditCard') || (payload.liabilityShifted === true) || (payload.liabilityShiftPossible === false)) {
      processTransaction(payload.nonce);
    } else {
      reinitializeBt();

      showMessage(error_payment_general);

      return false;
    }
  });
});

function processTransaction(nonce) {
  var params = {
    nonce: nonce,
    plan: pPackages.selected,
    duration: pPackages.plans[pPackages.selected].selected
  };

  $.post('{rpclink}ProcessBraintree&partner={raw}partner code{raw}|Account|Website{rpclink}', params, function (result) {
    if (typeof result.rpcStatus !== 'undefined') {
      if (result.rpcStatus === 1) {
        window.location = '{link}Account|Website|Partner&Extend={raw}partner code{raw}&Payment&Success|SSL{link}';
      } else {
        reinitializeBt();

        showMessage({lang json_encode}payment_transaction_error{lang} + ' ' + result.errorMessage);
      }
    } else {
      reinitializeBt();

      showMessage(error_payment_general);
    }
  }, 'json').fail(function() {
    reinitializeBt();

    showMessage(error_payment_general);
  });
}

function reinitializeBt() {
  btDropinInstance.clearSelectedPaymentMethod();

  if ($('#pPayButton').data('original-text')) {
    $('#pPayButton').html($('#pPayButton').data('original-text')).removeData('original-text');
  }

  $('#pPayButton').siblings().addClass('d-none');
  $('#pPayButton').removeClass('btn-success').addClass('btn-secondary').prop('disabled', true);
}

var partnerCampaign = {
  status: {raw json_encode}partner_campaign status{raw},
  dateEnd: {raw json_encode}partner_campaign date_end{raw},
  relativeDate: {raw json_encode}partner_campaign relative_date{raw}
};

var dateNow = new Date();
var dateEnd = new Date(partnerCampaign.dateEnd);

if (dateEnd instanceof Date && !isNaN(dateEnd)) {
  $('.pcdate').html(dateEnd.toLocaleDateString(undefined, {year: 'numeric', month: 'long', day: 'numeric'}));
}

if (partnerCampaign.status !== 1) {
  $('.pcdate').addClass('badge-danger');
} else {
  var diffDays = Math.round(Math.abs((dateEnd.getTime() - dateNow.getTime()) / (60*60*24*1000)));

  if (diffDays > 14) {
    $('.pcdate').addClass('badge-success');
  } else {
    $('.pcdate').addClass('badge-warning');
  }
}

$(function() {
  initializeBt();
});
</script>
