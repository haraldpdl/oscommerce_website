<div id="highlights">
  <img src="{ifvalue partner image_big_path}{publiclink}{value}partner image_big_path{value}{publiclink}{else}{publiclink}{value}highlights_image{value}{publiclink}{ifvalue}" alt="" title="{value}partner title{value}" />
</div>

<div class="row">
  {widget}account_sidebar_nav{widget}

  <div id="maincontainer" class="col-sm-9 col-sm-pull-3">
    <div id="maincontent">
      <div class="pull-right"><span class="pcdate label">{value}partner_campaign date_end{value}</span><br /><span class="pcdays text-muted small"></span></div>

      <h1>{value}partner title{value}</h1>

      {widget}message_stack|partner{widget}

      <h2>{lang}partner_extension_title{lang}</h2>

      <p>{lang}partner_extension_description{lang}</p>

      <div class="col-xs-6">
        <ul id="pPlanTabs" class="nav nav-tabs" role="tablist"></ul>

        <div id="pPlanTabsContent" class="tab-content"></div>
      </div>

      <div class="col-xs-6">
        <div class="panel panel-info">
          <div class="panel-heading text-center">
            <h3 id="pPlanTitle" class="panel-title"></h3>
          </div>

          <div class="panel-body">
            <form id="pForm" class="form">
              <address style="font-size: 0.8em;">{raw}partner_billing_address_formatted{raw}</address>

              <div class="form-group">
                <label for="pPlanSelection">{lang}cs_plans_duration_title{lang}</label>

                <select id="pPlanSelection" name="duration" class="form-control"></select>
              </div>

              <table id="orderTable" class="table table-condensed table-borderless">
                <tr id="orderTableTaxRow" class="hidden">
                  <td style="width: 70%;" id="orderTableTaxTitle" align="right"></td>
                  <td style="width: 30%;" id="orderTableTax" align="right"></td>
                </tr>
                <tr>
                  <td style="width: 70%;" align="right">{lang}purchase_item_total{lang}:</td>
                  <td style="width: 30%;" id="orderTableTotal" align="right"></td>
                </tr>
              </table>

              <div id="pPayAlert" class="alert alert-danger hidden" role="alert"></div>

              <i id="pBtFormIndicator" class="fa fa-spinner fa-spin"></i>
              <div id="pBtForm"></div>

              <p><button type="button" id="pPayButton" class="btn btn-info hidden" data-processing="{escape}{lang}cs_pay_processing_button{lang}{escape}" disabled></button></p>
            </form>
          </div>
        </div>
      </div>

      <div class="clearfix"></div>

      <p class="text-center"><small class="text-muted">{lang}cs_pricing_info{lang}</small></p>

      <h3>{lang}partner_extension_after_payment_title{lang}</h3>

      {lang}partner_extension_after_payment_description{lang}
    </div>
  </div>
</div>

<div id="bt3dsmodal" class="modal" tabindex="-1" role="dialog" data-backdrop="static" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body"></div>
    </div>
  </div>
</div>

<script>
var btClientInstance;
var btThreeDSecureInstance;
var btDropinInstance;
var bt3dsModalOpen = false;

var total_raw;

var error_payment_general = {lang json_encode}error_partner_payment_general{lang};

function showMessage(message) {
  $('#pPayAlert').append('<p>' + message + '</p>').removeClass('hidden');
}

var taxDescriptions = {
  'DE19MWST': {lang json_encode}purchase_tax_DE19MWST_title{lang}
};

var pPackages = {
  selected: {raw json_encode}partner_campaign pkg_code{raw},
  plans: {raw json_encode}partner_packages{raw}
};

pPackages.plans.silver.desc = [
  {
    title: {lang json_encode}cs_plans_service_partner_listing{lang},
    checked: true
  },
  {
    title: {lang json_encode}cs_plans_service_commercial_inquiries{lang},
    checked: true
  },
  {
    title: {lang json_encode}cs_plans_service_commercial_feedback{lang},
    checked: true
  },
  {
    title: {lang json_encode}cs_plans_service_profile{lang},
    checked: true
  }
];

pPackages.plans.gold.desc = [
  {
    title: {lang json_encode}cs_plans_service_silver_level{lang},
    checked: true
  },
  {
    title: {lang json_encode}cs_plans_service_partner_page{lang},
    checked: true
  },
  {
    title: {lang json_encode}cs_plans_service_promotions{lang},
    checked: true
  },
  {
    title: {lang json_encode}cs_plans_service_banner{lang},
    checked: true
  },
  {
    title: {lang json_encode}cs_plans_service_forum_channel{lang},
    checked: true
  },
  {
    title: {lang json_encode}cs_plans_service_showcase_sites{lang},
    checked: true
  },
  {
    title: {lang json_encode}cs_plans_service_extra{lang},
    checked: false
  }
];

$.each(pPackages.plans, function(index, value) {
  $('#pPlanTabs').append('<li role="presentation"><a data-target="#p' + index + 'Content" data-toggle="tab" data-code="' + index + '" aria-controls="p' + index + 'Content" role="tab">' + value.title_short + '</a></li>');

  $('#pPlanTabsContent').append('<div role="tabpanel" class="tab-pane" id="p' + index + 'Content"><table class="table table-hover table-borderless"><tbody></tbody></table></div>');

  $.each(value.desc, function(i, d) {
    var row = '<tr><td>' + d.title + '</td><td align="center">';

    if (d.checked === true) {
      row += '<i class="fa fa-check-square" style="color: #5cb85c; font-size: 1.6em;"></i>';
    }

    row += '</td></tr>';

    $('#p' + index + 'Content table tbody').append(row);
  });
});

$('#pPlanTabs li a[data-code="' + pPackages.selected + '"]').parent('li').addClass('active');
$('#p' + pPackages.selected + 'Content').addClass('active');

$('#pPlanTitle').html(pPackages.plans[pPackages.selected].title);

$.each(pPackages.plans[pPackages.selected].levels, function(lid, lvalue) {
  $('#pPlanSelection').append($('<option/>', {
    value: lid,
    text: lvalue.title + ' ' + lvalue.price
  }));
});

$('#pPlanSelection').val(pPackages.plans[pPackages.selected].selected);

var pPayButtonText = {lang json_encode}cs_pay_credit_card_button{lang};

if (typeof pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].tax !== 'undefined') {
  var t = pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].tax;

  $('#orderTableTaxTitle').html(taxDescriptions[Object.keys(t)[0]] + ':');
  $('#orderTableTax').html(t[Object.keys(t)[0]]);
  $('#orderTableTaxRow').removeClass('hidden');
} else {
  $('#orderTableTaxRow').addClass('hidden');
}

$('#orderTableTotal').html(pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].total);

$('#pPayButton').html(pPayButtonText.replace('#amount#', pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].total));

$('#pPlanTabs a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
  var p = $(e.target).data('code');

  pPackages.selected = p;

  $('#pPlanTitle').html(pPackages.plans[pPackages.selected].title);

  $('#pPlanSelection').find('option').remove();

  $.each(pPackages.plans[pPackages.selected].levels, function(lid, lvalue) {
    $('#pPlanSelection').append($('<option/>', {
      value: lid,
      text: lvalue.title + ' ' + lvalue.price
    }));
  });

  $('#pPlanSelection').val(pPackages.plans[pPackages.selected].selected);

  if (typeof pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].tax !== 'undefined') {
    var t = pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].tax;

    $('#orderTableTaxTitle').html(taxDescriptions[Object.keys(t)[0]] + ':');
    $('#orderTableTax').html(t[Object.keys(t)[0]]);
    $('#orderTableTaxRow').removeClass('hidden');
  } else {
    $('#orderTableTaxRow').addClass('hidden');
  }

  $('#orderTableTotal').html(pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].total);

  $('#pPayButton').html(pPayButtonText.replace('#amount#', pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].total));

  if (typeof btDropinInstance !== 'undefined') {
    btDropinInstance.updateConfiguration('paypal', 'amount', pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].total_raw);
  }
});

$('#pPlanSelection').on('change', function() {
  pPackages.plans[pPackages.selected].selected = this.value;

  total_raw = pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].total_raw;

  if (typeof pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].tax !== 'undefined') {
    var t = pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].tax;

    $('#orderTableTaxTitle').html(taxDescriptions[Object.keys(t)[0]] + ':');
    $('#orderTableTax').html(t[Object.keys(t)[0]]);
    $('#orderTableTaxRow').removeClass('hidden');
  } else {
    $('#orderTableTaxRow').addClass('hidden');
  }

  $('#orderTableTotal').html(pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].total);

  $('#pPayButton').html(pPayButtonText.replace('#amount#', pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].total));

  if (typeof btDropinInstance !== 'undefined') {
    btDropinInstance.updateConfiguration('paypal', 'amount', pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].total_raw);
  }
});

function initializeBt() {
  $('#pPayButton').addClass('hidden').prop('disabled', true);
  $('#pBtFormIndicator').removeClass('hidden')

  if ($('#pPayButton').data('orig-text')) {
    $('#pPayButton').html($('#pPayButton').data('orig-text')).removeData('orig-text').removeAttr('data-orig-text');
  }

  $.getJSON({raw json_encode}braintree_get_client_token_url{raw}, function (result) {
    if ((typeof result.rpcStatus !== 'undefined') && (result.rpcStatus === 1) && (typeof result.token !== 'undefined')) {
      braintree.client.create({
        authorization: result.token
      }, function (clientErr, clientInstance) {
        $('#pBtFormIndicator').addClass('hidden');

        if (clientErr) {
          showMessage(error_payment_general);

          return false;
        }

        btClientInstance = clientInstance;

        try {
          braintree.threeDSecure.create({
            client: btClientInstance
          }, function (threeDSecureErr, threeDSecureInstance) {
            if (threeDSecureErr) {
              showMessage(error_payment_general);

              return false;
            }

            btThreeDSecureInstance = threeDSecureInstance;

            createDropinInstance(result);
          });
        } catch (err) {
          showMessage(error_payment_general);

          return false;
        }
      });
    }
  });
}

function createDropinInstance(result) {
  total_raw = pPackages.plans[pPackages.selected].levels[pPackages.plans[pPackages.selected].selected].total_raw;

  braintree.dropin.create({
    authorization: result.token,
    container: '#pBtForm',
    paymentOptionPriority: ['paypal', 'card'],
/*
    card: {
      cardholderName: true
    },
*/
    paypal: {
      flow: 'checkout',
      amount: total_raw,
      currency: 'EUR',
      displayName: 'osCommerce',
      enableShippingAddress: false,
      buttonStyle: {
        size: 'small',
        color: 'blue',
        shape: 'rect'
      }
    }
  }, function (createErr, instance) {
    if (createErr) {
      showMessage(error_payment_general);

      return false;
    }

    btDropinInstance = instance;

    $('#pPayButton').removeClass('hidden');

    if (btDropinInstance.isPaymentMethodRequestable()) {
      $('#pPayButton').prop('disabled', false);
    }

    btDropinInstance.on('paymentMethodRequestable', function (event) {
      if ($('#pPayButton').html() != $('#pPayButton').data('processing')) {
        $('#pPayButton').prop('disabled', false);
      }
    });

    btDropinInstance.on('noPaymentMethodRequestable', function () {
      $('#pPayButton').prop('disabled', true);
    });
  });
}

$('#pPayButton').on('click', function(e) {
  e.preventDefault();

  $('#pPayAlert').empty().addClass('hidden');

  $('#pPayButton').data('orig-text', $('#pPayButton').html()).html($('#pPayButton').data('processing')).prop('disabled', true);

  btDropinInstance.requestPaymentMethod(function (requestPaymentMethodErr, payload) {
    if (requestPaymentMethodErr) {
      showMessage(error_payment_general);

      if ($('#pPayButton').data('orig-text')) {
        $('#pPayButton').html($('#pPayButton').data('orig-text')).removeData('orig-text').removeAttr('data-orig-text');
      }

      $('#pPayButton').prop('disabled', false);

      return false;
    }

    $('#pBtForm div[data-braintree-id="toggle"]').addClass('hidden');

    if (payload.type !== 'CreditCard') {
      processTransaction(payload.nonce);
    } else {
      verify3DSCard(payload);
    }
  });
});

function verify3DSCard(payload) {
  btThreeDSecureInstance.verifyCard({
    amount: total_raw,
    nonce: payload.nonce,
    addFrame: function (err, iframe) {
      bt3dsCancelledByUser = true;

      $('#bt3dsmodal .modal-body').html(iframe);
      $('#bt3dsmodal').modal();
    },
    removeFrame: function () {
      bt3dsCancelledByUser = false;

//        $('#bt3dsmodal .modal-body').html('');
//        $('#bt3dsmodal').modal('hide');
    }
  }, function (error, response) {
    if (error) {
      reinitializeBt();

      showMessage(error_payment_general);

      return false;
    }

    processTransaction(response.nonce);
  });
}

function processTransaction(nonce) {
  var params = {
    nonce: nonce,
    plan: pPackages.selected,
    duration: $('#pPlanSelection').val()
  };

  $.post('{rpclink}ProcessBraintree&partner={raw}partner code{raw}|Account|Website{rpclink}', params, function (result) {
    if (typeof result.rpcStatus !== 'undefined') {
      if (result.rpcStatus === 1) {
        window.location = '{link}Account|Website|Partner&Extend={raw}partner code{raw}&Payment&Success|SSL{link}';
      } else {
        reinitializeBt();

        showMessage({lang json_encode}payment_transaction_error{lang} + ' ' + result.errorMessage);
      }
    } else {
      reinitializeBt();

      showMessage(error_payment_general);
    }
  }, 'json').fail(function() {
    reinitializeBt();

    showMessage(error_payment_general);
  });
}

function reinitializeBt() {
  if (bt3dsModalOpen === true) {
    bt3dsCancelledByUser = true;

    $('#bt3dsmodal .modal-body').html('');
    $('#bt3dsmodal').modal('hide');
  } else {
    btDropinInstance.teardown(function(err) {
//        if (err) {
//          console.log(err);
//          return;
//        }

      initializeBt();
    });
  }
}

$('#bt3dsmodal').on('show.bs.modal', function (e) {
  bt3dsModalOpen = true;

  $('.modal-backdrop').css('backgroundColor', '#000');
});

$('#bt3dsmodal').on('hidden.bs.modal', function (e) {
  bt3dsModalOpen = false;

  $('.modal-backdrop').css('backgroundColor', '');

  if (bt3dsCancelledByUser === true) {
    btThreeDSecureInstance.cancelVerifyCard(function (err, payload) {
//        if (err) {
//          console.log(err);
//          return;
//        }

      reinitializeBt();
    });
  }
});

$(function() {
  initializeBt();

  var partner_date_now = moment({raw json_encode}partner_date_now{raw});
  var runsUntil = moment($('.pcdate').text());

  $('.pcdate').text(runsUntil.format('Do MMM, YYYY'));

  if (runsUntil.isBefore(partner_date_now)) {
    $('.pcdate').addClass('label-danger');

    $('.pcdays').html(runsUntil.from(partner_date_now));
  } else {
    var daysRemaining = runsUntil.diff(partner_date_now, 'days');

    $('.pcdays').html(partner_date_now.to(runsUntil));

    if ( daysRemaining > 14 ) {
      $('.pcdate').addClass('label-success');
    } else {
      $('.pcdate').addClass('label-warning');
    }
  }
});
</script>
