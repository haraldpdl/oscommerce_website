{ifvalue highlights_image}
<div id="highlights">
  <img src="{publiclink}{raw}highlights_image{raw}{publiclink}" />
</div>
{ifvalue}

<div class="row">
  <div id="maincontainer" class="col-xs-12">
    <div id="maincontent">
      <h1>{lang}amb_page_title{lang}</h1>

      {lang}amb_main_content{lang}

      <h2>{lang}amb_plan_title{lang}</h2>

      <div class="row" style="padding-bottom: 20px;">
        <div class="col-md-6 col-md-push-6">
          <div id="ambStart">
            <div class="jumbotron" style="margin-bottom: 0px;">
              <div class="text-center">
                <h1>{lang}amb_price{lang}<sup style="vertical-align: top; font-size: 0.25em; top: 20px;">*</sup> <small>{lang}lifetime{lang}</small></h1>

                {iftrue is_ambassador}
                <p>{lang}welcome_boost{lang}</p>

                <p><a id="ambStartButton" class="btn btn-success btn-lg" role="button">{lang}button_boost_ambassador_level{lang}</a></p>
                {else}
                <p>{lang}welcome_start{lang}</p>

                <p><a id="ambStartButton" class="btn btn-success btn-lg" role="button">{lang}button_become_an_ambassador{lang}</a></p>
                {iftrue}
              </div>
            </div>

            <p class="text-muted text-center" style="padding: 10px 20px; font-size: 0.85em;">{lang}amb_pricing_info{lang}</p>
          </div>

          <div id="ambLogin" class="hidden" style="background-color: #eee; border-radius: 6px; padding: 25px 25px;">
            <h3 style="margin-top: 0px;">{lang}login_title{lang}</h3>

            <div class="alert alert-danger hidden" role="alert" style="font-size: 0.9em;"></div>

            <form id="ambLoginForm">{formprotect}public_token{formprotect}
              <div class="row">
                <div class="col-xs-6">
                  <div class="form-group">
                    <label for="cUsername" class="control-label" style="font-size: 0.9em;">{lang}login_username_title{lang}</label>
                    <input type="input" class="form-control" id="cUsername">
                    <span id="cUsernameAlert" class="help-block hidden small"></span>
                  </div>
                </div>

                <div class="col-xs-6">
                  <div class="form-group">
                    <label for="cPassword" class="control-label" style="font-size: 0.9em;">{lang}login_password_title{lang}</label>
                    <input type="password" class="form-control" id="cPassword">
                    <span id="cPasswordAlert" class="help-block hidden small"></span>
                  </div>
                </div>
              </div>

              <p class="text-right"><button type="submit" id="ambLoginButton" class="btn btn-success" data-processing-text="{lang addslashes}login_processing_button_title{lang}">{lang}login_button_title{lang}</button></p>
            </form>

            <p style="font-size: 0.9em;">{lang}login_account_required_reason{lang}</p>

            <p style="font-size: 0.9em;"><a id="ambCreateAccountLink" role="button">{lang}login_create_account_info{lang}</a></p>
          </div>

          <div id="ambCreateAccount" class="hidden" style="background-color: #eee; border-radius: 6px; padding: 25px 25px;">
            <h3 style="margin-top: 0px;">{lang}create_title{lang}</h3>

            <div class="alert alert-danger hidden" role="alert" style="font-size: 0.9em;"></div>

            <form id="ambCreateAccountForm">{formprotect}public_token{formprotect}
              <div class="row">
                <div class="col-xs-6">
                  <div class="form-group">
                    <label for="cnUsername" class="control-label" style="font-size: 0.9em;">{lang}create_username_title{lang}</label>
                    <input type="input" class="form-control" id="cnUsername">
                    <span id="cnUsernameAlert" class="help-block small text-muted">{lang}create_username_note{lang}</span>
                  </div>
                </div>

                <div class="col-xs-6">
                  <div class="form-group">
                    <label for="cnEmail" class="control-label" style="font-size: 0.9em;">{lang}create_email_address_title{lang}</label>
                    <input type="email" class="form-control" id="cnEmail">
                    <span id="cnEmailAlert" class="help-block hidden small"></span>
                  </div>
                </div>

                <div class="col-xs-12">
                  <div class="form-group">
                    <label for="cnPassword" class="control-label" style="font-size: 0.9em;">{lang}create_password_title{lang}</label>
                    <input type="password" class="form-control" id="cnPassword">
                    <span id="cnPasswordAlert" class="help-block small text-muted">{lang}create_password_note{lang}</span>
                  </div>
                </div>

                <div class="col-xs-12">
                  <div class="form-group">
                    <label for="cnSecurityCheck" class="control-label">{lang}create_security_check_title{lang}</label>
                    <div id="cnSecurityCheck"></div>
                    <span id="cnSecurityCheckAlert" class="help-block hidden small"></span>
                  </div>
                </div>

                <div class="col-xs-12">
                  <div class="checkbox">
                    <label class="control-label">
                      <input type="checkbox" id="cnTOS">
                      {lang}create_tos_agree_title{lang}
                      <span id="cnTOSAlert" class="help-block hidden small"></span>
                    </label>
                  </div>
                </div>
              </div>

              <p class="text-right"><button type="submit" id="ambCreateAccountButton" class="btn btn-success" data-processing-text="{lang addslashes}create_processing_button_title{lang}">{lang}create_button_title{lang}</button></p>
            </form>

            <p style="font-size: 0.9em;"><a id="ambLoginLink" role="button">{lang}create_login_link{lang}</a></p>
          </div>

          <div id="ambVerifyAccount" class="hidden" style="background-color: #eee; border-radius: 6px; padding: 25px 25px;">
            <h3 style="margin-top: 0px;">{lang}verify_title{lang}</h3>

            <div class="alert alert-success hidden" role="alert" style="font-size: 0.9em;"></div>

            <p style="font-size: 0.9em;">{lang}verify_introduction{lang}</p>

            <div class="alert alert-danger hidden" role="alert" style="font-size: 0.9em;"></div>

            <form id="ambVerifyAccountForm">{formprotect}public_token{formprotect}
              <div class="row">
                <div class="col-xs-4">
                  <div class="form-group">
                    <label for="cvUserId" class="control-label" style="font-size: 0.9em;">{lang}verify_user_id_title{lang}</label>
                    <input type="tel" class="form-control" id="cvUserId">
                    <span id="cvUserIdAlert" class="help-block hidden small"></span>
                  </div>
                </div>

                <div class="col-xs-8">
                  <div class="form-group">
                    <label for="cvKey" class="control-label" style="font-size: 0.9em;">{lang}verify_key_title{lang}</label>
                    <input type="input" class="form-control" id="cvKey">
                    <span id="cvKeyAlert" class="help-block hidden small"></span>
                  </div>
                </div>
              </div>

              <p class="text-right"><button type="submit" id="ambVerifyAccountButton" class="btn btn-success" data-processing-text="{lang addslashes}verify_processing_button_title{lang}">{lang}verify_button_title{lang}</button></p>
            </form>
          </div>

          <div id="ambBillingAddress" class="hidden" style="background-color: #eee; border-radius: 6px; padding: 25px 25px;">
            <h3 style="margin-top: 0px;">{lang}billing_address_title{lang}</h3>

            <p style="font-size: 0.9em;">{lang}billing_address_introduction{lang}</p>

            <div class="alert alert-danger hidden" role="alert" style="font-size: 0.9em;"></div>

            <form id="ambBillingAddressForm">
              <div class="row">
                <div class="col-xs-6">
                  <div class="form-group">
                    <label for="cFirstName" class="control-label" style="font-size: 0.9em;">{lang}billing_firstname_title{lang}</label>
                    <input type="input" class="form-control" id="cFirstName">
                  </div>
                </div>

                <div class="col-xs-6">
                  <div class="form-group">
                    <label for="cLastName" class="control-label" style="font-size: 0.9em;">{lang}billing_lastname_title{lang}</label>
                    <input type="input" class="form-control" id="cLastName">
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-xs-6">
                  <div class="form-group">
                    <label for="cStreetAddress" class="control-label" style="font-size: 0.9em;">{lang}billing_street_address_title{lang}</label>
                    <input type="input" class="form-control" id="cStreetAddress">
                  </div>
                </div>

                <div class="col-xs-6">
                  <div class="form-group">
                    <label for="cStreetAddress2" class="control-label" style="font-size: 0.9em;">{lang}billing_street_address2_title{lang}</label>
                    <input type="input" class="form-control" id="cStreetAddress2" placeholder="optional">
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-xs-6">
                  <div class="form-group">
                    <label for="cCity" class="control-label" style="font-size: 0.9em;">{lang}billing_city_title{lang}</label>
                    <input type="input" class="form-control" id="cCity">
                  </div>
                </div>

                <div class="col-xs-6">
                  <div class="form-group">
                    <label for="cZip" class="control-label" style="font-size: 0.9em;">{lang}billing_zip_title{lang}</label>
                    <input type="input" class="form-control" id="cZip">
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-xs-6">
                  <div class="form-group">
                    <label for="cCountry" class="control-label" style="font-size: 0.9em;">{lang}billing_country_title{lang}</label>
                    {raw}field_countries{raw}
                  </div>
                </div>

                <div class="col-xs-6">
                  <div class="form-group">
                    <label class="control-label" style="font-size: 0.9em;">{lang}billing_state_title{lang}</label>
                    <input type="input" class="form-control hidden" id="cState">
                    <select id="cStateSelect" class="form-control hidden"></select>
                    <p class="form-control-static" style="font-size: 1.0em;"><small>{lang}billing_country_select_first{lang}</small></p>
                  </div>
                </div>
              </div>
            </form>

            <p class="text-right"><button type="button" id="ambBillingAddressButton" class="btn btn-success" data-processing-text="{lang addslashes}billing_address_processing_button_title{lang}">{lang}billing_address_continue_button_title{lang}</button></p>
          </div>

          <div id="ambPayment" class="hidden" style="background-color: #eee; border-radius: 6px; padding: 25px 25px;">
            <div id="btBranding" class="pull-right">
              <img src="{publiclink}images/braintree-badge-wide-light.png{publiclink}" width="202px" height ="32px" border="0" alt="Payments by Braintree">
            </div>

            <address id="orderBillingAddress"></address>

            <table id="orderTable" class="table"></table>

            <div class="alert alert-danger hidden" role="alert" style="font-size: 0.9em;"></div>

            <i id="ambBtFormIndicator" class="fa fa-spinner fa-spin"></i>
            <div id="ambBtForm"></div>

            <p class="text-right"><i class="fa fa-long-arrow-right text-success hidden" style="padding: 6px 12px; font-size: 18px;"></i> <button id="ambPaymentButton" class="btn btn-default hidden" type="button" data-processing="{lang addslashes}payment_processing_button_title{lang}" disabled>{lang}payment_pay_now_button_title{lang}</button></p>

            <p id="ambPaymentTerms" class="text-muted hidden" style="font-size: 0.7em;">{lang}payment_tos_agree{lang}</p>
          </div>

          <div id="ambSuccess" class="hidden" style="background-color: #eee; border-radius: 6px; padding: 25px 25px;">
            <div class="row">
              <div class="col-xs-3 text-center" style="margin-top: 30px;">
                <span class="fa-stack fa-5x">
                  <i class="fa fa-circle fa-stack-2x" style="color: #ffcccc;"></i>
                  <i class="fa fa-heart fa-stack-1x text-danger"></i>
                </span>
              </div>

              <div class="col-xs-9 text-center">
                <h1>{lang}success_title{lang}</h1>

                {lang}success_description{lang}

                <p><a href="https://forums.oscommerce.com" class="btn btn-success">{lang}success_visit_forum_button_title{lang}</a></p>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-md-pull-6">
          <table class="table table-hover table-borderless">
            <tbody>
              <tr>
                <td>{lang}amb_plan_profile{lang}</td>
                <td align="center"><i class="fa fa-check-square" style="color: #5cb85c; font-size: 1.6em;"></i></td>
              </tr>
              <tr>
                <td>{lang}amb_plan_apps{lang}</td>
                <td align="center"><i class="fa fa-check-square" style="color: #5cb85c; font-size: 1.6em;"></i></td>
              </tr>
              <tr>
                <td>{lang}amb_plan_sites{lang}</td>
                <td align="center"><i class="fa fa-check-square" style="color: #5cb85c; font-size: 1.6em;"></i></td>
              </tr>
              <tr>
                <td>{lang}amb_plan_commercial{lang}</td>
                <td align="center"><i class="fa fa-check-square" style="color: #5cb85c; font-size: 1.6em;"></i></td>
              </tr>
              <tr>
                <td>{lang}amb_plan_commercial_feedback{lang}</td>
                <td align="center"><i class="fa fa-check-square" style="color: #5cb85c; font-size: 1.6em;"></i></td>
              </tr>
              <tr>
                <td>{lang}amb_plan_search{lang}</td>
                <td align="center"><i class="fa fa-check-square" style="color: #5cb85c; font-size: 1.6em;"></i></td>
              </tr>
              <tr>
                <td>{lang}amb_plan_pm{lang}</td>
                <td align="center"><i class="fa fa-check-square" style="color: #5cb85c; font-size: 1.6em;"></i></td>
              </tr>
              <tr>
                <td>{lang}amb_plan_forum_channel{lang}</td>
                <td align="center"><i class="fa fa-check-square" style="color: #5cb85c; font-size: 1.6em;"></i></td>
              </tr>
              <tr>
                <td>{lang}amb_plan_gift_membership{lang}</td>
                <td align="center"><i class="fa fa-check-square" style="color: #5cb85c; font-size: 1.6em;"></i></td>
              </tr>
              <tr>
                <td>{lang}amb_plan_multi_levels{lang}</td>
                <td align="center"><i class="fa fa-check-square" style="color: #5cb85c; font-size: 1.6em;"></i></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <h3>{lang}amb_newest_ambassadors_title{lang}</h3>

      <div class="row">
        {loop amb_members}
        <div class="col-xs-3 col-sm-2 col-lg-1">
          <a href="https://forums.oscommerce.com/profile/#id#-#name_slug#/"><img src="#photo#" class="img-circle center-block" style="margin-top: 10px; margin-bottom: 10px; width: 75px; height: 75px;" title="#name#"></a>
        </div>
        {loop}
      </div>

      <h3>{lang}amb_payment_acceptance_title{lang}</h3>

      {lang}amb_payment_acceptance_description{lang}

      <h3>{lang}amb_after_payment_title{lang}</h3>

      {lang}amb_after_payment_description{lang}
    </div>
  </div>
</div>

<div id="tosPane" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="tosPaneLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3 class="modal-title" id="tosPaneLabel">{lang}create_tos_title{lang}</h3>
      </div>

      <div class="modal-body">
        {lang}create_tos_body{lang}
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-info" data-dismiss="modal">{lang}create_tos_close{lang}</button>
      </div>
    </div>
  </div>
</div>

<div id="ambTosPane" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="ambTosPaneLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3 class="modal-title" id="ambTosPaneLabel">{lang}payment_tos_title{lang}</h3>
      </div>

      <div class="modal-body">
        {lang}payment_tos_body{lang}
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-info" data-dismiss="modal">{lang}payment_tos_close{lang}</button>
      </div>
    </div>
  </div>
</div>

<div id="bt3dsmodal" class="modal" tabindex="-1" role="dialog" data-backdrop="static" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body"></div>
    </div>
  </div>
</div>

<script>
$(function() {
  var loggedIn = {ifvalue user}true{else}false{ifvalue};
  var zones = {raw json_encode}select_zones{raw};
{ifvalue billing_address}
  var billing_address = {raw json_encode}billing_address{raw};
{else}
  var billing_address;
{ifvalue}
  var address;
  var total_raw;
  var paymentButtonText = $('#ambPaymentButton').html();
  var hasError = false;
  var gSecurityCheck;
  var panelCurrent = 'Start';
  var panelLast;

  var btClientInstance;
  var btDropinInstance;
  var btThreeDSecureInstance;
  var bt3dsPayload;
  var bt3dsCancelledByUser = true;
  var bt3dsModalOpen = false;

  var error_login_general = {lang json_encode}login_ms_error_general{lang};
  var error_create_general = {lang json_encode}create_ms_error_general{lang};
  var error_verify_general = {lang json_encode}verify_ms_error_general{lang};
  var error_payment_general = {lang json_encode}payment_ms_error_general{lang};

  if ('MutationObserver' in window) {
    var paymentButtonObserver = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.oldValue === null) {
          $('#ambPaymentButton').siblings('i').addClass('hidden');

          if ($('#ambPaymentButton').html() != $('#ambPaymentButton').data('processing')) {
            $('#ambPaymentButton').removeClass('btn-success').addClass('btn-default');
          }
        } else {
          if ($('#ambPaymentButton').html() != $('#ambPaymentButton').data('processing')) {
            $('#ambPaymentButton').siblings('i').removeClass('hidden');
            $('#ambPaymentButton').removeClass('btn-default').addClass('btn-success');
          }
        }
      });
    });

    paymentButtonObserver.observe(document.getElementById('ambPaymentButton'), {
      attributes: true,
      attributeOldValue: true,
      attributeFilter: [
        'disabled'
      ]
    });
  }

  function showPanel(panel) {
    panelLast = panelCurrent;
    panelCurrent = panel;

    $('#amb' + panelLast).addClass('hidden');
    $('#amb' + panelCurrent).removeClass('hidden');
  }

  function showMessage(id, message, type) {
    if (typeof type === 'undefined') {
      type = 'danger';
    }

    $('#' + id + ' div.alert-' + type).append('<p>' + message + '</p>').removeClass('hidden');
  }

  function showInlineError(id, error, container) {
    hasError = true;

    if (typeof container === 'undefined') {
      container = '.form-group';
    }

    $('#' + id).closest(container).addClass('has-error');

    if (typeof error !== 'undefined') {
      $('#' + id + 'Alert').html(error).removeClass('hidden');
    }
  }

  function clearInlineError(id, container) {
    if (typeof container === 'undefined') {
      container = '.form-group';
    }

    if ($('#' + id + 'Alert').hasClass('text-muted') === false) {
      $('#' + id + 'Alert').addClass('hidden');
    }

    $('#' + id).closest(container).removeClass('has-error');
  }

  function prefillBillingAddress() {
    if (typeof billing_address !== 'undefined') {
      $('#cFirstName').val(billing_address.firstname);
      $('#cLastName').val(billing_address.lastname);
      $('#cStreetAddress').val(billing_address.street);
      $('#cStreetAddress2').val(billing_address.street2);
      $('#cCity').val(billing_address.city);
      $('#cZip').val(billing_address.zip);
      $('#cCountry').val(billing_address.country_iso_2).trigger('change');

      if (billing_address.country_iso_2 in zones) {
        $('#cStateSelect').val(billing_address.zone_code).trigger('change');
      } else {
        $('#cState').val(billing_address.state);
      }
    }
  }

  $('#cCountry').on('change', function(e) {
    if ($(this).val() === '') {
      $('#cState, #cStateSelect').addClass('hidden');
      $('#cState').siblings('.form-control-static').removeClass('hidden');
      $('#cState').siblings('label').removeAttr('for');
    } else if ($(this).val() in zones) {
      $('#cStateSelect').empty();

      $('#cStateSelect').append('<option value="">' + {lang json_encode}select_please_select{lang} + '</option>');

      zones[$(this).val()].forEach(function (value) {
        $('#cStateSelect').append('<option value="' + value.code + '">' + value.title + '</option>');
      });

      $('#cState').siblings('.form-control-static').addClass('hidden');
      $('#cState').addClass('hidden');
      $('#cStateSelect').removeClass('hidden');
      $('#cState').siblings('label').attr('for', 'cStateSelect');
    } else {
      $('#cState').siblings('.form-control-static').addClass('hidden');
      $('#cStateSelect').addClass('hidden');
      $('#cState').removeClass('hidden');
      $('#cState').siblings('label').attr('for', 'cState');
    }
  });

  $('#ambStartButton').on('click', function(e) {
    e.preventDefault();

    if (loggedIn === true) {
      prefillBillingAddress();

      showPanel('BillingAddress');
    } else {
      showPanel('Login');
    }
  });

  $('#ambCreateAccountLink').on('click', function(e) {
    e.preventDefault();

    if (typeof gSecurityCheck === 'undefined') {
      gSecurityCheck = grecaptcha.render('cnSecurityCheck', {
        'sitekey': {raw json_encode}recaptcha_key_public{raw}
      });
    }

    showPanel('CreateAccount');
  });

  $('#ambLoginLink').on('click', function(e) {
    e.preventDefault();

    showPanel('Login');
  });

  $('#ambLoginForm').submit(function(e) {
    e.preventDefault();

    if ($('#ambLoginButton').prop('disabled') === true) {
      return false;
    }

    $('#ambLogin div.alert').empty().addClass('hidden');

    hasError = false;

    $('#ambLoginButton').button('processing').prop('disabled', true);

    $('#cUsername').val($('#cUsername').val().trim());

    clearInlineError('cUsername');

    if (($('#cUsername').val().length < 3) || ($('#cUsername').val().length > 26)) {
      showInlineError('cUsername', {lang json_encode}login_username_js_error{lang});
    }

    clearInlineError('cPassword');

    if (($('#cPassword').val().length < 3) || ($('#cPassword').val().length > 32)) {
      showInlineError('cPassword', {lang json_encode}login_password_js_error{lang});
    }

    if (hasError === true) {
      $('#ambLoginButton').button('reset').prop('disabled', false);
    } else {
      var params = {
        public_token: $('#ambLoginForm input[name="public_token"]').val(),
        username: $('#cUsername').val(),
        password: $('#cPassword').val(),
        sendVerification: '1',
        addressType: 'billing'
      };

      $.post('{rpclink}Login|Account|Website{rpclink}', params, function (result) {
        if (typeof result.rpcStatus !== 'undefined') {
          if (result.rpcStatus === 1) {
            loggedIn = true;

            if (typeof result.address !== 'undefined') {
              billing_address = result.address;

              prefillBillingAddress();
            }

            showPanel('BillingAddress');
          } else {
            if ((typeof result.errorCode !== 'undefined') && (result.errorCode === 'not_verified')) {
              $('#ambVerifyEmailAddress').html(result.email);

              showPanel('VerifyAccount');
            } else {
              var e = (typeof result.errors !== 'undefined') ? result.errors : [];

              if (e.length < 1) {
                e.push(error_login_general);
              }

              e.forEach(function(v) {
                showMessage('ambLogin', v);
              });
            }
          }
        } else {
          showMessage('ambLogin', error_login_general);
        }
      }, 'json').fail(function() {
        showMessage('ambLogin', error_login_general);
      }).always(function() {
        $('#ambLoginButton').button('reset').prop('disabled', false);
      });
    }
  });

  $('#ambVerifyAccountForm').submit(function(e) {
    e.preventDefault();

    if ($('#ambVerifyAccountButton').prop('disabled') === true) {
      return false;
    }

    $('#ambVerifyAccount div.alert').empty().addClass('hidden');

    hasError = false;

    $('#ambVerifyAccountButton').button('processing').prop('disabled', true);

    $('#cvUserId').val($('#cvUserId').val().trim());

    clearInlineError('cvUserId');

    if (($('#cvUserId').val().match(/^\d+$/g) === null) || ($('#cvUserId').val() < 1)) {
      showInlineError('cvUserId', {lang json_encode}verify_user_id_js_error{lang});
    }

    $('#cvKey').val($('#cvKey').val().trim());

    clearInlineError('cvKey');

    if (($('#cvKey').val().length !== 32) || ($('#cvKey').val().match(/^[a-zA-Z0-9\-\_]+$/g) === null)) {
      showInlineError('cvKey', {lang json_encode}verify_verification_key_js_error{lang});
    }

    if (hasError === true) {
      $('#ambVerifyAccountButton').button('reset').prop('disabled', false);
    } else {
      var params = {
        public_token: $('#ambVerifyAccountForm input[name="public_token"]').val(),
        user_id: $('#cvUserId').val(),
        key: $('#cvKey').val()
      };

      $.post('{rpclink}Verify|Account|Website{rpclink}', params, function (result) {
        if (typeof result.rpcStatus !== 'undefined') {
          if (result.rpcStatus === 1) {
            var login_params;

            if (panelLast === 'Login') {
              login_params = {
                public_token: $('#ambLoginForm input[name="public_token"]').val(),
                username: $('#cUsername').val(),
                password: $('#cPassword').val()
              };
            } else if (panelLast === 'CreateAccount') {
              login_params = {
                public_token: $('#ambCreateAccountForm input[name="public_token"]').val(),
                username: $('#cnUsername').val(),
                password: $('#cnPassword').val()
              };
            }

            if (typeof login_params.username !== 'undefined') {
              $.post('{rpclink}Login|Account|Website{rpclink}', login_params, function (login_result) {
                if ((typeof login_result.rpcStatus !== 'undefined') && (login_result.rpcStatus === 1)) {
                  loggedIn = true;

                  if (typeof login_result.address !== 'undefined') {
                    billing_address = login_result.address;

                    prefillBillingAddress();
                  }

                  showPanel('BillingAddress');
                } else {
                  showPanel('Login');
                }
              }, 'json').fail(function() {
                showPanel('Login');
              }).always(function() {
                $('#ambVerifyAccountButton').button('reset').prop('disabled', false);
              });
            } else {
              showPanel('Login');
            }
          } else {
            if ((typeof result.errorCode !== 'undefined') && (result.errorCode === 'already_verified')) {
              showMessage('ambLogin', 'already_verified');

              $('#cvUserId, #cvKey, #cUsername, #cPassword').val('');

              showPanel('Login');
            } else {
              var e = (typeof result.errors !== 'undefined') ? result.errors : [];

              if (e.length < 1) {
                e.push(error_verify_general);
              }

              e.forEach(function(v) {
                showMessage('ambVerify', v);
              });
            }

            $('#ambVerifyAccountButton').button('reset').prop('disabled', false);
          }
        } else {
          showMessage('ambVerifyAccount', error_verify_general);

          $('#ambVerifyAccountButton').button('reset').prop('disabled', false);
        }
      }, 'json').fail(function() {
        showMessage('ambVerifyAccount', error_verify_general);

        $('#ambVerifyAccountButton').button('reset').prop('disabled', false);
      });
    }
  });

  $('#ambCreateAccountForm').submit(function(e) {
    e.preventDefault();

    if ($('#ambCreateAccountButton').prop('disabled') === true) {
      return false;
    }

    $('#ambCreateAccount div.alert').empty().addClass('hidden');

    hasError = false;

    $('#ambCreateAccountButton').button('processing').prop('disabled', true);

    $('#cnUsername').val($('#cnUsername').val().trim());

    clearInlineError('cnUsername');

    if (($('#cnUsername').val().length < 3) || ($('#cnUsername').val().length > 26)) {
      showInlineError('cnUsername');
    }

    $('#cnEmail').val($('#cnEmail').val().trim());

    clearInlineError('cnEmail');

    if (($('#cnEmail').val() === '') || ($('#cnEmail').val().match(/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/g) === null)) {
      showInlineError('cnEmail', {lang json_encode}create_email_address_js_error{lang});
    }

    clearInlineError('cnPassword');

    if (($('#cnPassword').val().length < 3) || ($('#cnPassword').val().length > 32)) {
      showInlineError('cnPassword');
    }

    clearInlineError('cnSecurityCheck');

    if ($('#ambCreateAccountForm textarea[name="g-recaptcha-response"]').val().length < 1) {
      showInlineError('cnSecurityCheck', {lang json_encode}create_security_check_js_error{lang});
    }

    clearInlineError('cnTOS', '.checkbox');

    if (!$('#cnTOS').is(':checked')) {
      showInlineError('cnTOS', {lang json_encode}create_tos_agree_js_error{lang}, '.checkbox');
    }

    if (hasError === true) {
      $('#ambCreateAccountButton').button('reset').prop('disabled', false);
    } else {
      var params = {
        public_token: $('#ambCreateAccountForm input[name="public_token"]').val(),
        username: $('#cnUsername').val(),
        email: $('#cnEmail').val(),
        password: $('#cnPassword').val(),
        gr_security_check: $('#ambCreateAccountForm textarea[name="g-recaptcha-response"]').val(),
        agree_tos: $('#cnTOS').is(':checked') ? 1 : 0,
        sendVerification: '1'
      };

      $.post('{rpclink}Create|Account|Website{rpclink}', params, function (result) {
        if (typeof result.rpcStatus !== 'undefined') {
          if (result.rpcStatus === 1) {
            showMessage('ambVerifyAccount', {lang json_encode}create_verify_account{lang}, 'success');

            $('#ambVerifyEmailAddress').html(result.email);

            showPanel('VerifyAccount');
          } else {
            var e = (typeof result.errors !== 'undefined') ? result.errors : [];

            if (e.length < 1) {
              e.push(error_create_general);
            }

            e.forEach(function(v) {
              showMessage('ambCreateAccount', v);
            });

            if ((typeof result.resetGSecurityCheck !== 'undefined') && (result.resetGSecurityCheck === true)) {
              grecaptcha.reset(gSecurityCheck);
            }
          }
        } else {
          showMessage('ambCreateAccount', error_create_general);
        }
      }, 'json').fail(function() {
        showMessage('ambCreateAccount', error_create_general);
      }).always(function() {
        $('#ambCreateAccountButton').button('reset').prop('disabled', false);
      });
    }
  });

  $('#ambBillingAddressButton').on('click', function(e) {
    e.preventDefault();

    var hasError = false;

    $('#ambBillingAddressButton').button('processing').prop('disabled', true);

    $('#ambBillingAddressForm div.form-group.has-error').removeClass('has-error');

    if ($('#cFirstName').val().length < 1) {
      hasError = true;

      $('#cFirstName').parent('.form-group').addClass('has-error');
    }

    if ($('#cLastName').val().length < 1) {
      hasError = true;

      $('#cLastName').parent('.form-group').addClass('has-error');
    }

    if ($('#cStreetAddress').val().length < 1) {
      hasError = true;

      $('#cStreetAddress').parent('.form-group').addClass('has-error');
    }

    if ($('#cCity').val().length < 1) {
      hasError = true;

      $('#cCity').parent('.form-group').addClass('has-error');
    }

    if (($('#cCountry').val() === '') || ($('#cCountry').val() in zones) && ($('#cStateSelect').val() === '') || (!($('#cCountry').val() in zones) && ($('#cState').val().length < 1))) {
      hasError = true;

      $('#cState').parent('.form-group').addClass('has-error');
    }

    if ($('#cZip').val().length < 1) {
      hasError = true;

      $('#cZip').parent('.form-group').addClass('has-error');
    }

    if ($('#cCountry').val() === '') {
      hasError = true;

      $('#cCountry').parent('.form-group').addClass('has-error');
    }

    if (hasError === false) {
      address = {
        firstname: $('#cFirstName').val(),
        lastname: $('#cLastName').val(),
        street: $('#cStreetAddress').val(),
        street2: $('#cStreetAddress2').val(),
        city: $('#cCity').val(),
        zip: $('#cZip').val(),
        country: $('#cCountry').val()
      }

      if ($('#cCountry').val() in zones) {
        address.zone = $('#cStateSelect').val();
      } else {
        address.zone = $('#cState').val();
      }

      initializeBt();
    } else {
      $('#ambBillingAddressButton').button('reset').prop('disabled', false);
    }
  });

  function initializeBt() {
    $('#ambPaymentButton').addClass('hidden');
    $('#ambPaymentTerms').addClass('hidden');

    $('#ambPaymentButton').removeClass('btn-success').addClass('btn-default');

    if ($('#ambPaymentButton').data('orig-text')) {
      $('#ambPaymentButton').html($('#ambPaymentButton').data('orig-text')).removeData('orig-text').removeAttr('data-orig-text');
    }

    if ($('#ambPaymentButton').prop('disabled') !== true) {
      $('#ambPaymentButton').prop('disabled', true);
    }

    $.post('{rpclink}GetBraintreeClientToken|_|Website{rpclink}', address, function (result) {
      if ((typeof result.rpcStatus !== 'undefined') && (result.rpcStatus === 1) && (typeof result.token !== 'undefined')) {
        $('#orderBillingAddress').html(result.addressFormatted);

        $.each(result.items, function(i, value) {
          $('#orderTable').append('<tr><td>' + value.title + '</td><td align="right">' + value.cost + '</td></tr>');
        });

        $.each(result.totals, function(i, value) {
          $('#orderTable').append('<tr><td align="right">' + value.title + ':</td><td align="right">' + value.cost + '</td></tr>');
        });

        var blush = 'Uh, thanks for reading this <3 #vollgerne';

        showPanel('Payment');

        braintree.client.create({
          authorization: result.token
        }, function (clientErr, clientInstance) {
          $('#ambBtFormIndicator').addClass('hidden');

          if (clientErr) {
            showMessage('ambPayment', error_payment_general);

            return false;
          }

          btClientInstance = clientInstance;

          try {
            braintree.threeDSecure.create({
              client: btClientInstance
            }, function (threeDSecureErr, threeDSecureInstance) {
              if (threeDSecureErr) {
                showMessage('ambPayment', error_payment_general);

                return false;
              }

              btThreeDSecureInstance = threeDSecureInstance;

              createDropinInstance(result);
            });
          } catch (err) {
            showMessage('ambPayment', error_payment_general);

            return false;
          }
        });
      }
    }, 'json').always(function() {
      $('#ambBillingAddressButton').button('reset').prop('disabled', false);
    });
  }

  function createDropinInstance(result) {
    total_raw = result.totals.total.cost_raw;

    braintree.dropin.create({
      authorization: result.token,
      container: '#ambBtForm',
      paymentOptionPriority: ['paypal', 'card'],
/*
      card: {
        cardholderName: true
      },
*/
      paypal: {
        flow: 'checkout',
        amount: total_raw,
        currency: 'EUR',
        displayName: 'osCommerce',
        enableShippingAddress: false,
        buttonStyle: {
          size: 'small',
          color: 'blue',
          shape: 'rect'
        }
      }
    }, function (createErr, instance) {
      if (createErr) {
        showMessage('ambPayment', error_payment_general);

        return false;
      }

      btDropinInstance = instance;

      $('#ambPaymentButton').html(paymentButtonText + ' ' + result.totals.total.cost).removeClass('hidden');
      $('#ambPaymentTerms').removeClass('hidden');

      if (btDropinInstance.isPaymentMethodRequestable()) {
        $('#ambPaymentButton').prop('disabled', false);
      }

      btDropinInstance.on('paymentMethodRequestable', function (event) {
        if ($('#ambPaymentButton').html() != $('#ambPaymentButton').data('processing')) {
          $('#ambPaymentButton').prop('disabled', false);
        }
      });

      btDropinInstance.on('noPaymentMethodRequestable', function () {
        $('#ambPaymentButton').prop('disabled', true);
      });
    });
  }

  $('#ambPaymentButton').on('click', function(e) {
    e.preventDefault();

    $('#ambPayment div.alert').empty().addClass('hidden');

    $('#ambPaymentButton').data('orig-text', $('#ambPaymentButton').html()).html($('#ambPaymentButton').data('processing')).prop('disabled', true);

    btDropinInstance.requestPaymentMethod(function (requestPaymentMethodErr, payload) {
      if (requestPaymentMethodErr) {
        showMessage('ambPayment', error_payment_general);

        if ($('#ambPaymentButton').data('orig-text')) {
          $('#ambPaymentButton').html($('#ambPaymentButton').data('orig-text')).removeData('orig-text').removeAttr('data-orig-text');
        }

        $('#ambPaymentButton').prop('disabled', false);

        return false;
      }

      $('#ambBtForm div[data-braintree-id="toggle"]').addClass('hidden');

      if (payload.type !== 'CreditCard') {
        processTransaction(payload.nonce);
      } else {
        verify3DSCard(payload);
      }
    });
  });

  function verify3DSCard(payload) {
    btThreeDSecureInstance.verifyCard({
      amount: total_raw,
      nonce: payload.nonce,
      addFrame: function (err, iframe) {
        bt3dsCancelledByUser = true;

        $('#bt3dsmodal .modal-body').html(iframe);
        $('#bt3dsmodal').modal();
      },
      removeFrame: function () {
        bt3dsCancelledByUser = false;

//        $('#bt3dsmodal .modal-body').html('');
//        $('#bt3dsmodal').modal('hide');
      }
    }, function (error, response) {
      if (error) {
        reinitializeBt();

        showMessage('ambPayment', error_payment_general);

        return false;
      }

      processTransaction(response.nonce);
    });
  }

  function processTransaction(nonce) {
    var params = {
      nonce: nonce,
      address: address
    };

    $.post('{rpclink}ProcessBraintree|_|Website{rpclink}', params, function (result) {
      if (typeof result.rpcStatus !== 'undefined') {
        if (result.rpcStatus === 1) {
          bt3dsCancelledByUser = false;

          $('#bt3dsmodal .modal-body').html('');
          $('#bt3dsmodal').modal('hide');

          showPanel('Success');
        } else {
          reinitializeBt();

          showMessage('ambPayment', {lang json_encode}payment_transaction_error{lang} + ' ' + result.errorMessage);
        }
      } else {
        reinitializeBt();

        showMessage('ambPayment', error_payment_general);
      }
    }, 'json').fail(function() {
      reinitializeBt();

      showMessage('ambPayment', error_payment_general);
    });
  }

  function reinitializeBt() {
    if (bt3dsModalOpen === true) {
      bt3dsCancelledByUser = true;

      $('#bt3dsmodal .modal-body').html('');
      $('#bt3dsmodal').modal('hide');
    } else {
      btDropinInstance.teardown(function(err) {
//        if (err) {
//          console.log(err);
//          return;
//        }

        initializeBt();
      });
    }
  }

  $('#bt3dsmodal').on('show.bs.modal', function (e) {
    bt3dsModalOpen = true;

    $('.modal-backdrop').css('backgroundColor', '#000');
  });

  $('#bt3dsmodal').on('hidden.bs.modal', function (e) {
    bt3dsModalOpen = false;

    $('.modal-backdrop').css('backgroundColor', '');

    if (bt3dsCancelledByUser === true) {
      btThreeDSecureInstance.cancelVerifyCard(function (err, payload) {
//        if (err) {
//          console.log(err);
//          return;
//        }

        reinitializeBt();
      });
    }
  });
});
</script>
